name: FastAPI CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: sirisha-test1
  GKE_CLUSTER: gke-demo-cluster
  GKE_ZONE: us-central1-a
  IMAGE_NAME: fastapi-gke-demo
  DOCKER_IMAGE: us-central1-docker.pkg.dev/sirisha-test1/fastapi-repo/fastapi-gke-demo

jobs:
  # ------------------ Checkout ------------------
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

  # ------------------ Install dependencies ------------------
  install:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install --no-cache-dir -r app/requirements.txt

  # ------------------ Linting ------------------
  lint:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - name: Install flake8 & black
        run: pip install flake8 black
      - name: Run flake8
        run: flake8 app --max-line-length=100
      - name: Run black (format check)
        run: black --check app

  # ------------------ Security Scanning ------------------
  security:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Install Bandit
        run: pip install bandit
      - name: Run Bandit scan
        run: bandit -r app -ll

  # ------------------ Unit Test ------------------
  test:
    runs-on: ubuntu-latest
    needs: security
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install --no-cache-dir -r app/requirements.txt
      - name: Run tests
        run: |
          export PYTHONPATH=.
          pytest --maxfail=1 --disable-warnings --cov=app -q

  # ------------------ Build & Push Docker Image ------------------
  build:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v4
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build Docker image
        run: docker build -t $DOCKER_IMAGE:${{ github.sha }} .

      - name: Push Docker image
        run: docker push $DOCKER_IMAGE:${{ github.sha }}

  # ------------------ Scan Docker Image ------------------
  scan-image:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Scan Docker Image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true

  # ------------------ Update Deployment for Argo CD ------------------
  update-deployment:
    runs-on: ubuntu-latest
    needs: scan-image
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # ✅ This allows push using GITHUB_TOKEN

      - name: Update deployment.yaml with new image tag
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sed -i "s|image:.*|image: $DOCKER_IMAGE:${{ github.sha }}|" k8s/deployment.yaml
          else
            sed -i '' "s|image:.*|image: $DOCKER_IMAGE:${{ github.sha }}|" k8s/deployment.yaml
          fi

      - name: Commit & push updated deployment.yaml
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "github-actions"
          git add k8s/deployment.yaml
          git diff --cached --quiet || git commit -m "Update deployment image to ${{ github.sha }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ✅ Uses the token provided automatically

